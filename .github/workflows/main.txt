name: Trading Bot CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1. Ğ¢ĞµÑÑ‚Ñ‹
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  tests:
    name: Run tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: tbot_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: tbot
        ports:
          - "5432:5432"
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run linting
        run: |
          pip install flake8
          flake8 src/ --max-line-length=120 --ignore=E501,W503 || true

      - name: Test config loading
        env:
          POSTGRES_HOST: 127.0.0.1
          POSTGRES_PORT: 5432
          POSTGRES_DB: tbot
          POSTGRES_USER: tbot_user
          POSTGRES_PASSWORD: test_password
          TINKOFF_TOKEN: test_token
          TELEGRAM_BOT_TOKEN: test_bot_token
          TELEGRAM_CHAT_ID: "123456"
        run: |
          cd src
          python -c "print('Python OK')"

      # Ğ¢ĞµÑÑ‚ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹ Ğ½Ğ° Ñ‡Ğ¸ÑÑ‚Ğ¾Ğ¹ Ğ‘Ğ”
      - name: Test Alembic migrations
        env:
          POSTGRES_HOST: 127.0.0.1
          POSTGRES_PORT: 5432
          POSTGRES_DB: tbot
          POSTGRES_USER: tbot_user
          POSTGRES_PASSWORD: test_password
        run: |
          cd src
          echo "ğŸ—ƒï¸ Testing Alembic migrations..."
          alembic upgrade head
          echo "âœ… Migrations OK"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2. Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ğ¿ÑƒÑˆ Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build_and_push_to_docker_hub:
    name: Push Docker image to DockerHub
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN_RW }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: ${{ secrets.DOCKER_USERNAME }}/tbot_backend:latest

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 3. Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: Deploy to server
    runs-on: ubuntu-latest
    needs: build_and_push_to_docker_hub

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          source: "docker-compose.production.yml,config.yaml"
          target: tbot

      - name: Deploy over SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            set -e

            cd tbot

            echo "ğŸ“ Ensuring environment variables in .env..."
            grep -q "^DOCKER_IMAGE=" .env || echo "DOCKER_IMAGE=${{ secrets.DOCKER_USERNAME }}/tbot_backend" >> .env
            grep -q "^DOCKER_TAG=" .env || echo "DOCKER_TAG=latest" >> .env

            echo "ğŸ” Login to Docker Hub..."
            echo "${{ secrets.DOCKERHUB_TOKEN_RO }}" | sudo docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            echo "ğŸ§¹ Cleanup old images..."
            sudo docker system prune -f

            echo "ğŸ“¥ Pulling new images..."
            sudo docker compose -f docker-compose.production.yml pull

            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # ĞœĞ˜Ğ“Ğ ĞĞ¦Ğ˜Ğ˜ Ğ‘Ğ”
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            echo "ğŸ—ƒï¸ Running database migrations..."
            sudo docker compose -f docker-compose.production.yml run --rm \
              -e POSTGRES_HOST=db \
              bot alembic upgrade head
            
            if [ $? -eq 0 ]; then
              echo "âœ… Database migrations completed successfully"
            else
              echo "âŒ Database migrations failed!"
              exit 1
            fi

            echo "ğŸ”„ Restarting bot service (keeping database)..."
            sudo docker compose -f docker-compose.production.yml up -d --no-deps bot

            echo "â³ Waiting for services to start..."
            sleep 30

            sudo docker compose -f docker-compose.production.yml ps

            echo "ğŸ§¹ Safe cleanup (preserving data)..."
            sudo docker container prune -f
            sudo docker image prune -f

            echo "ğŸ” Checking service health..."
            for i in {1..12}; do
              if sudo docker compose -f docker-compose.production.yml ps | grep -q "Up"; then
                echo "âœ… Services are running"
                break
              fi
              echo "â³ Waiting for services to become healthy... ($i/12)"
              sleep 10
            done

            echo "âœ… Deployment completed! Final status:"
            sudo docker compose -f docker-compose.production.yml ps

            echo "ğŸ“‹ Recent bot logs:"
            sudo docker compose -f docker-compose.production.yml logs --tail=20 bot

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 4. Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Telegram
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  send_message:
    name: Notify via Telegram
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Send Telegram message
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ğŸ¤– Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Trading Bot ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½!
            
            ğŸ”§ ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚: ${{ github.sha }}
            ğŸ‘¤ ĞĞ²Ñ‚Ğ¾Ñ€: ${{ github.actor }}
            ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            âœ… Ğ‘Ğ¾Ñ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½
            âœ… ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ‘Ğ” Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ñ‹
            âœ… Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ PostgreSQL ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹
            âœ… ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° Ğ² 06:30 ĞœĞ¡Ğš

            âš ï¸ Ğ¢Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»Ñ Ğ½ĞµÑÑ‘Ñ‚ Ñ€Ğ¸ÑĞº Ğ¿Ğ¾Ñ‚ĞµÑ€Ğ¸ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°