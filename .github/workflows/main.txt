name: Trading Bot CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/trading_bot
  DEPLOY_PATH: ~/trading_bot

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1. Ğ¢ĞµÑÑ‚Ñ‹ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  tests:
    name: Run tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: trader
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: trading_bot_test
        ports:
          - "5432:5432"
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run linting
        run: |
          pip install flake8
          flake8 src/ --max-line-length=120 --ignore=E501,W503 || true

      - name: Run tests
        env:
          POSTGRES_HOST: 127.0.0.1
          POSTGRES_PORT: 5432
          POSTGRES_DB: trading_bot_test
          POSTGRES_USER: trader
          POSTGRES_PASSWORD: test_password
          TINKOFF_TOKEN: test_token
          TELEGRAM_BOT_TOKEN: test_bot_token
          TELEGRAM_CHAT_ID: "123456"
        run: |
          cd src
          python -c "from config import load_config; print('Config OK')" || echo "Config test skipped"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2. Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ğ¿ÑƒÑˆ Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build_and_push:
    name: Build and push Docker image
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 3. Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: Deploy to server
    runs-on: ubuntu-latest
    needs: build_and_push

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          source: "docker-compose.production.yml,config.yaml"
          target: ${{ env.DEPLOY_PATH }}

      - name: Deploy over SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            set -e
            
            cd ${{ env.DEPLOY_PATH }}
            
            echo "ğŸ” Login to Docker Hub..."
            echo "${{ secrets.DOCKER_TOKEN }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            
            echo "ğŸ“¥ Pulling new images..."
            docker compose -f docker-compose.production.yml pull
            
            echo "ğŸ”„ Stopping bot gracefully (keeping database)..."
            docker compose -f docker-compose.production.yml stop bot || true
            
            echo "ğŸš€ Starting services..."
            docker compose -f docker-compose.production.yml up -d
            
            echo "â³ Waiting for database..."
            sleep 10
            
            echo "ğŸ”„ Running database migrations..."
            docker compose -f docker-compose.production.yml exec -T bot python -c "
            import asyncio
            from db.repository import Repository
            from config import load_config
            
            async def migrate():
                config = load_config('/app/config.yaml')
                repo = Repository(config.database.url)
                await repo.init_db()
                print('âœ… Database initialized')
                await repo.close()
            
            asyncio.run(migrate())
            " || echo "âš ï¸ Migration skipped (will run on startup)"
            
            echo "ğŸ§¹ Cleanup old images (keeping data volumes)..."
            docker image prune -f
            
            echo "ğŸ” Health check..."
            for i in {1..6}; do
              if docker compose -f docker-compose.production.yml ps | grep -q "Up"; then
                echo "âœ… Services are running"
                break
              fi
              echo "â³ Waiting... ($i/6)"
              sleep 10
            done
            
            echo "ğŸ“‹ Service status:"
            docker compose -f docker-compose.production.yml ps
            
            echo "ğŸ“‹ Recent logs:"
            docker compose -f docker-compose.production.yml logs --tail=30 bot

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 4. Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Telegram
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify:
    name: Notify via Telegram
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Send success message
        if: ${{ needs.deploy.result == 'success' }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            âœ… Trading Bot Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ ÑƒÑĞ¿ĞµÑˆĞµĞ½!
            
            ğŸ“¦ ĞĞ±Ñ€Ğ°Ğ·: ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
            ğŸ‘¤ ĞĞ²Ñ‚Ğ¾Ñ€: ${{ github.actor }}
            ğŸ’¬ ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚: ${{ github.event.head_commit.message }}
            
            ğŸ”— ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ğŸ¤– Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ¸ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµÑ‚ 06:30 ĞœĞ¡Ğš

      - name: Send failure message
        if: ${{ needs.deploy.result == 'failure' }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            âŒ Trading Bot Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ ĞŸĞ ĞĞ’ĞĞ›Ğ•Ğ!
            
            ğŸ‘¤ ĞĞ²Ñ‚Ğ¾Ñ€: ${{ github.actor }}
            ğŸ’¬ ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚: ${{ github.event.head_commit.message }}
            
            ğŸ”— ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            âš ï¸ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°!
